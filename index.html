<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>마니또</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; line-height: 1.45; }
    h1 { font-size: 18px; margin: 0 0 12px; }
    .card { border:1px solid #eee; border-radius:12px; padding:12px; margin:12px 0; background:#fafafa; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:10px 0; }
    select, input { padding:10px; border:1px solid #ccc; border-radius:10px; font-size:14px; }
    button { padding:10px 12px; border:0; border-radius:10px; background:#111; color:#fff; cursor:pointer; }
    .warn { color:#b00020; font-weight:600; }
    .small { font-size:12px; color:#555; }
  </style>
</head>
<body>
  <h1>마니또 확인</h1>
  <div class="small">이름 선택 후, 운영자에게 받은 개인코드를 입력하세요.</div>

  <div class="card">
    <div class="row">
      <label>내 이름</label>
      <select id="myName"></select>
    </div>
    <div class="row">
      <label>개인코드</label>
      <input id="myCode" placeholder="개인코드 입력" autocomplete="off" />
      <button id="btnReveal">내 마니또 확인</button>
    </div>
    <div class="small">코드가 틀리면 복호화가 실패합니다.</div>
  </div>

  <div class="card">
    <h2 style="font-size:14px;margin:0 0 8px;">결과</h2>
    <div id="result" style="font-size:16px;"></div>
    <div id="resultErr" class="warn"></div>
  </div>

<script>
const NAMES = [
  "김구선","김성태","김영신","김재윤","이체","황인미",
  "정대호","정유경","최은선","최정선","전혜원"
];

/**
 * ✅ 여기에 운영자(organizer.html)에서 복사한 ENCRYPTED JSON을 붙여넣으세요.
 * 예:
 * let ENCRYPTED = { "김구선": {"salt":"...","iv":"...","ct":"..."}, ... };
 */
let ENCRYPTED = let ENCRYPTED = {
  "김구선": {
    "salt": "HC24UYQgSmABY5CzLK7zIA==",
    "iv": "317rCUZYN+vtDCiV",
    "ct": "IePPcGAtN9ZyDJucW4oDL4q2/s7b6EfrhQ=="
  },
  "김성태": {
    "salt": "5lX8LJYxL+GRdkO8Q+W+nQ==",
    "iv": "aaREhgOCw68XlimY",
    "ct": "aEp3udNikdrLWCnzRBgS7qytO9Hiww=="
  },
  "김영신": {
    "salt": "3WXPaTg5oJfwjhfSWtf1bw==",
    "iv": "rpXalLS1CY1me89O",
    "ct": "8RPVs+91hurjKgRw+IbOrt/zPRrLsNGaqg=="
  },
  "김재윤": {
    "salt": "nkUoLqDF9CK/yE0mTavnQA==",
    "iv": "LeTG4HVdkKjTzn7V",
    "ct": "Eg2QZh+YxH/ON+847upX3EKIHHxj/M1FCA=="
  },
  "이체": {
    "salt": "1ARA8G//kPwiXjfpvDaOlw==",
    "iv": "M48aTp4ANvmn7Njx",
    "ct": "d6tjx5AO9WsX1gNYFwmsmz39PJk2/uLS8A=="
  },
  "황인미": {
    "salt": "7wY5r2A+wgHLc7queTwVCw==",
    "iv": "VE6WBBEFCuDWsv7V",
    "ct": "UrCow5krAdyKfmeIwUi/WkNad0LsxjuM+g=="
  },
  "정대호": {
    "salt": "XGaz36x6ajfVxwZa51zvlA==",
    "iv": "YZhpWPKQa1gqBlJn",
    "ct": "b8Dll4qq4M68I1VrSJ4bAIcJCFNsNXMiJw=="
  },
  "정유경": {
    "salt": "80vmOdWLvY8NehQfncxoTQ==",
    "iv": "HHuNF+WdBjJSL9Cb",
    "ct": "liGuwnMXAWmvIHsfjalCR1xmtS9YOR51CA=="
  },
  "최은선": {
    "salt": "o3shqQFWZ6rvAbuFwDXg8w==",
    "iv": "DSr7cklGei2rryLC",
    "ct": "B0MI1D7m00qMhJTm0b/mbGwEmjNPJy0XHA=="
  },
  "최정선": {
    "salt": "np/YUX6qF/zIKkWiBKs/Pw==",
    "iv": "pIQD4fs732EPqj8C",
    "ct": "s7th9AyOAbihkYfjrB/ya1QdIyqF5W6CHA=="
  },
  "전혜원": {
    "salt": "00vd0Bb3dFwEPsLX0t1aAg==",
    "iv": "36kvHWVx2wJHe0hA",
    "ct": "rffL9SWdlrgngDLZbXGD1rMppFx4l9xMaQ=="
  };

function $(id){ return document.getElementById(id); }
function fillNames(){
  const sel = $("myName");
  sel.innerHTML = "";
  for(const n of NAMES){
    const opt = document.createElement("option");
    opt.value = n;
    opt.textContent = n;
    sel.appendChild(opt);
  }
}

function strToU8(str){ return new TextEncoder().encode(str); }
function u8ToStr(u8){ return new TextDecoder().decode(u8); }
function unb64(s){
  const bin = atob(s);
  const u8 = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
  return u8;
}
async function deriveKey(code, saltU8){
  const baseKey = await crypto.subtle.importKey("raw", strToU8(code), "PBKDF2", false, ["deriveKey"]);
  return crypto.subtle.deriveKey(
    { name:"PBKDF2", salt:saltU8, iterations:120000, hash:"SHA-256" },
    baseKey,
    { name:"AES-GCM", length:256 },
    false,
    ["decrypt"]
  );
}
async function decryptWith(code, payload){
  const salt = unb64(payload.salt);
  const iv   = unb64(payload.iv);
  const ct   = unb64(payload.ct);
  const key  = await deriveKey(code, salt);
  const ptBuf = await crypto.subtle.decrypt({ name:"AES-GCM", iv }, key, ct);
  return u8ToStr(new Uint8Array(ptBuf));
}

$("btnReveal").addEventListener("click", async ()=>{
  $("result").textContent = "";
  $("resultErr").textContent = "";

  if(!ENCRYPTED){
    $("resultErr").textContent = "매칭 데이터가 없습니다. 운영자에게 배포본 업데이트를 요청하세요.";
    return;
  }

  const name = $("myName").value;
  const code = $("myCode").value.trim().toUpperCase();
  if(!name || !code){
    $("resultErr").textContent = "이름과 개인코드를 입력하세요.";
    return;
  }

  try{
    const payload = ENCRYPTED[name];
    if(!payload){ $("resultErr").textContent = "해당 이름의 데이터가 없습니다."; return; }
    const target = await decryptWith(code, payload);
    $("result").textContent = `${name}님의 마니또 대상: ${target}`;
  }catch(e){
    $("resultErr").textContent = "복호화 실패: 코드가 틀렸거나 데이터가 손상되었습니다.";
  }
});

fillNames();
</script>
</body>
</html>
